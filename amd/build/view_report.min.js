define(["jquery","core/templates","core/notification","core/ajax","core/str"],function(a,b,c,d,e){return{init:function(){var b=this,f=function(b,f,g,h,i){var j=["id","courseid","embedded","sesskey","_qf__report_edit_form","mform_isexpanded_id_general","prefname","presaved","prefdelete","prefdefault"],k=b.serializeArray(),l=[],m=0;a.each(k,function(b,c){a.inArray(c.name,j)===-1&&l.push(c)}),d.call([{methodname:"block_configurable_reports_update_filter_preferences",args:{id:f,reportid:g,name:h,parameters:JSON.stringify(l),defaultfilter:m,action:"update"}}])[0].done(function(b){b.success===!0?(null!==i&&i.append('<option value="'+b.id+'" selected="selected">'+h+"</option>"),f>0&&e.get_strings([{key:"message",component:"block_configurable_reports"},{key:"saved",component:"block_configurable_reports"}]).done(function(a){c.alert(a[0],a[1])}).fail(c.exception),a("#id_presaved").show().removeAttr("hidden"),a("#id_prefupdate").show().removeAttr("hidden"),a("#id_prefdelete").show().removeAttr("hidden"),a("#id_prefdefault").show().removeAttr("hidden")):c.alert(null,b.msg)}).fail(c.exception)};a(document).ready(function(){a("#id_filter_subcategories").val()>0&&b.getCourses(),a(document).on("change","#id_filter_subcategories",function(a){a.preventDefault(),b.getCourses()}),a("#id_prefsave").click(function(b){b.preventDefault();var c=a(this).closest("form"),d=a("input[name=prefname]"),e=a("select[name=presaved]"),g=a("input[name=id]").val(),h=d.val().trim();""!==h&&f(c,0,g,h,e)}),a("#id_prefupdate").click(function(b){b.preventDefault();var c=a(this).closest("form"),d=(a("input[name=prefname]"),a("select[name=presaved]")),e=d.val(),g=a("input[name=id]").val();f(c,e,g,"",null)}),a("#id_presaved").change(function(){var b=a(this).closest("form"),e=a(this).val();e>0&&d.call([{methodname:"block_configurable_reports_get_filter_preferences",args:{id:e}}])[0].done(function(d){if(d===!1)c.alert(null,"Error!");else{var e=JSON.parse(d.filter);a.each(e,function(b,c){var d=a("#id_"+c.name);d.length>0&&d.val(c.value)})}b.submit()}).fail(c.exception)}),a("#id_prefdelete").click(function(b){b.preventDefault();var e=parseInt(a("select[name=presaved]").val()),f=a("input[name=id]").val(),g=a("select[name=presaved] option:selected").text().trim();0!==e&&d.call([{methodname:"block_configurable_reports_update_filter_preferences",args:{id:e,reportid:f,name:g,parameters:"",defaultfilter:0,action:"delete"}}])[0].done(function(b){b.success===!0?a("select[name=presaved] option[value="+e+"]").remove():c.alert(null,b.msg)}).fail(c.exception)}),a("#id_prefdefault").click(function(b){b.preventDefault();var f=parseInt(a("select[name=presaved]").val()),g=a("input[name=id]").val(),h=a("select[name=presaved] option:selected").text().trim();0!==f&&d.call([{methodname:"block_configurable_reports_update_filter_preferences",args:{id:f,reportid:g,name:h,parameters:"",defaultfilter:1,action:"setdefault"}}])[0].done(function(b){b.success===!0?e.get_string("default").done(function(c){if(a('select[name=presaved] option:contains("('+c+')")').each(function(){a(this).text(a(this).text().replace(" ("+c+")",""))}),"removed"!==b.msg){var d=a("select[name=presaved] option[value="+f+"]");d.text(d.text()+" ("+c+")")}}):c.alert(null,b.msg)}).fail(c.exception)})})},getCourses:function(){var b=this,c=a("#id_filter_courses").val();a("#id_filter_courses").html("");var d=a("#id_filter_subcategories").val();a.ajax({type:"GET",url:"get_courses_in_category.php?category="+d,success:function(a){b.replaceTemplate("#id_filter_courses","block_configurable_reports/courses",a,c)}})},replaceTemplate:function(d,e,f,g){b.render(e,f).done(function(c,e){a(d).html(c),b.runTemplateJS(e),g&&0!==a("#id_filter_courses option[value='"+g+"']").length&&a("#id_filter_courses").val(g)}).fail(c.exception)}}});