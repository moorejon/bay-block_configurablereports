define(["jquery","core/templates","core/notification","core/ajax","core/str"],function(a,b,c,d,e){return{init:function(){var b=this,f=function(b,f,h,i,k){var l=j(b),m=0;d.call([{methodname:"block_configurable_reports_update_filter_preferences",args:{id:f,reportid:h,name:i,parameters:JSON.stringify(l),defaultfilter:m,action:"update"}}])[0].done(function(b){b.success===!0?(null!==k&&(!k.children().length>0&&k.append('<option value="0"></option>'),k.append('<option value="'+b.id+'" selected="selected">'+i+"</option>")),f>0&&e.get_strings([{key:"message",component:"block_configurable_reports"},{key:"saved",component:"block_configurable_reports"}]).done(function(a){c.alert(a[0],a[1])}).fail(c.exception),g(),a("#id_prefname").val("")):c.alert(null,b.msg)}).fail(c.exception)},g=function(){a("#id_prefupdate").show(),a("#id_prefdelete").show(),a("#id_prefdefault").show()},h=function(){a("#id_prefupdate").hide(),a("#id_prefdelete").hide(),a("#id_prefdefault").hide()},i=function(b){var c=j(b);a.each(c,function(b,c){var d=a("#id_"+c.name);d.length>0&&("SELECT"==d.prop("tagName")?d.prop("selectedIndex",0):d.val(""))})},j=function(b){var c=["id","courseid","embedded","sesskey","_qf__report_edit_form","mform_isexpanded_id_general","prefname","presaved","prefdelete","prefdefault"],d=b.serializeArray(),e=[];return a.each(d,function(b,d){a.inArray(d.name,c)===-1&&e.push(d)}),e};a(document).ready(function(){a("#id_filter_subcategories").val()>0&&b.getCourses(),a(document).on("change","#id_filter_subcategories",function(a){a.preventDefault(),b.getCourses()}),a("#id_prefsave").click(function(b){b.preventDefault();var c=a("input[name=prefname]"),d=a("select[name=presaved]"),e=a(this).closest("form"),g=a("input[name=id]").val(),h=c.val().trim();""!==h&&f(e,0,g,h,d)}),a("#id_prefupdate").click(function(b){b.preventDefault();var c=a("select[name=presaved]"),d=a(this).closest("form"),e=c.val(),g=a("input[name=id]").val();f(d,e,g,"",null)}),a("#id_presaved").change(function(){var b=a(this).val(),e=a(this).closest("form");b>0?(d.call([{methodname:"block_configurable_reports_get_filter_preferences",args:{id:b}}])[0].done(function(b){if(b===!1)c.alert(null,"Error!");else{i(e);var d=JSON.parse(b.filter);a.each(d,function(b,c){var d=a("#id_"+c.name);d.length>0&&d.val(c.value)})}}).fail(c.exception),g()):(i(e),h())}),a("#id_prefdelete").click(function(b){b.preventDefault();var e=parseInt(a("select[name=presaved]").val()),f=a("input[name=id]").val(),g=a("select[name=presaved] option:selected").text().trim(),j=a(this).closest("form");0!==e&&d.call([{methodname:"block_configurable_reports_update_filter_preferences",args:{id:e,reportid:f,name:g,parameters:"",defaultfilter:0,action:"delete"}}])[0].done(function(b){b.success===!0?(a("select[name=presaved] option[value="+e+"]").remove(),i(j),h()):c.alert(null,b.msg)}).fail(c.exception)}),a("#id_prefdefault").click(function(b){b.preventDefault();var f=parseInt(a("select[name=presaved]").val()),g=a("input[name=id]").val(),h=a("select[name=presaved] option:selected").text().trim();0!==f&&d.call([{methodname:"block_configurable_reports_update_filter_preferences",args:{id:f,reportid:g,name:h,parameters:"",defaultfilter:1,action:"setdefault"}}])[0].done(function(b){b.success===!0?e.get_string("default").done(function(c){if(a('select[name=presaved] option:contains("('+c+')")').each(function(){a(this).text(a(this).text().replace(" ("+c+")",""))}),"removed"!==b.msg){var d=a("select[name=presaved] option[value="+f+"]");d.text(d.text()+" ("+c+")")}}):c.alert(null,b.msg)}).fail(c.exception)})})},getCourses:function(){var b=this,c=a("#id_filter_courses").val();a("#id_filter_courses").html("");var d=a("#id_filter_subcategories").val();a.ajax({type:"GET",url:"get_courses_in_category.php?category="+d,success:function(a){b.replaceTemplate("#id_filter_courses","block_configurable_reports/courses",a,c)}})},replaceTemplate:function(d,e,f,g){b.render(e,f).done(function(c,e){a(d).html(c),b.runTemplateJS(e),g&&0!==a("#id_filter_courses option[value='"+g+"']").length&&a("#id_filter_courses").val(g)}).fail(c.exception)}}});