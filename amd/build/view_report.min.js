define(["jquery","core/templates","core/notification","core/ajax","core/str"],function(a,b,c,d,e){return{init:function(){var b=this;a(document).ready(function(){a("#id_filter_subcategories").val()>0&&b.getCourses(),a(document).on("change","#id_filter_subcategories",function(a){a.preventDefault(),b.getCourses()}),a("#id_prefsave").click(function(b){b.preventDefault();var e=a(this).closest("form"),f=a("input[name=prefname]"),g=a("select[name=presaved]"),h=f.data("id"),i=a("input[name=id]").val(),j=0,k=f.val().trim(),l=[];if(""!==k){var m=["id","courseid","embedded","sesskey","_qf__report_edit_form","mform_isexpanded_id_general","prefname","presaved","prefdelete","prefdefault"],n=e.serializeArray();a.each(n,function(b,c){a.inArray(c.name,m)===-1&&l.push(c)}),d.call([{methodname:"block_configurable_reports_update_filter_preferences",args:{id:h,reportid:i,name:k,parameters:JSON.stringify(l),defaultfilter:j,action:"update"}}])[0].done(function(b){b.success===!0?(g.append('<option value="" selected="selected">'+k+"</option>"),a("#id_presaved").show().removeAttr("hidden"),a("#id_prefdelete").show().removeAttr("hidden"),a("#id_prefdefault").show().removeAttr("hidden")):c.alert(null,b.msg)}).fail(c.exception)}}),a("#id_presaved").change(function(){var b=a(this).closest("form"),e=a(this).val();e>0&&d.call([{methodname:"block_configurable_reports_get_filter_preferences",args:{id:e}}])[0].done(function(d){if(d===!1)c.alert(null,"Error!");else{var e=JSON.parse(d.filter);a.each(e,function(b,c){var d=a("#id_"+c.name);d.length>0&&d.val(c.value)})}b.submit()}).fail(c.exception)}),a("#id_prefdelete").click(function(b){b.preventDefault();var e=a("select[name=presaved]").val(),f=a("input[name=id]").val(),g=a("select[name=presaved] option:selected").text().trim();e&&d.call([{methodname:"block_configurable_reports_update_filter_preferences",args:{id:e,reportid:f,name:g,parameters:"",defaultfilter:0,action:"delete"}}])[0].done(function(b){b.success===!0?a("select[name=presaved] option[value="+e+"]").remove():c.alert(null,b.msg)}).fail(c.exception)}),a("#id_prefdefault").click(function(b){b.preventDefault();var f=a("select[name=presaved]").val(),g=a("input[name=id]").val(),h=a("select[name=presaved] option:selected").text().trim();f&&d.call([{methodname:"block_configurable_reports_update_filter_preferences",args:{id:f,reportid:g,name:h,parameters:"",defaultfilter:1,action:"setdefault"}}])[0].done(function(b){b.success===!0?e.get_string("default").done(function(b){a('select[name=presaved] option:contains("('+b+')")').each(function(){a(this).text(a(this).text().replace(" ("+b+")",""))});var c=a("select[name=presaved] option[value="+f+"]");c.text(c.text()+" ("+b+")")}):c.alert(null,b.msg)}).fail(c.exception)})})},getCourses:function(){var b=this,c=a("#id_filter_courses").val();a("#id_filter_courses").html("");var d=a("#id_filter_subcategories").val();a.ajax({type:"GET",url:"get_courses_in_category.php?category="+d,success:function(a){b.replaceTemplate("#id_filter_courses","block_configurable_reports/courses",a,c)}})},replaceTemplate:function(d,e,f,g){b.render(e,f).done(function(c,e){a(d).html(c),b.runTemplateJS(e),g&&0!==a("#id_filter_courses option[value='"+g+"']").length&&a("#id_filter_courses").val(g)}).fail(c.exception)}}});